#+TITLE: auth-source-sops

Integrate [[https://getsops.io/][sops]] with Emacs ~auth-source~. This package allows you to store your secrets in encrypted YAML or JSON files and access them seamlessly from Emacs packages that use the standard ~auth-source~ API (like TRAMP, Gnus, etc.).

* Installation & Configuration

** Prerequisites

1. *sops binary*: The [[https://getsops.io/][sops]] executable must be installed and available in your ~exec-path~.
2. *yaml.el*: Required for parsing decrypted YAML data.
3. *Emacs 25.1+*: Built-in ~json.el~ is used for JSON support.

** 1. Installation

Clone this repository and add it to your Emacs ~load-path~:

#+begin_src elisp
(add-to-list 'load-path "/path/to/auth-source-sops")
(require 'auth-source-sops)
#+end_src

** 2. Setup

Configure the location of your encrypted secrets file and (optionally) your age key file. Then call ~auth-source-sops-enable~ to register the backend.

#+begin_src elisp
;; Specify your encrypted secrets file (YAML or JSON)
(setq auth-source-sops-file "~/.authinfo.sops.yaml")

;; (Optional) Specify a file containing your age private key
;; This sets the SOPS_AGE_KEY environment variable for the sops process
(setq auth-source-sops-age-key "~/.config/sops/age/keys.txt")

;; Enable the integration
(auth-source-sops-enable)
#+end_src

~auth-source-sops-enable~ will verify that ~sops~ is installed and append ~sops~ to the global ~auth-sources~ list.

*** YAML Structure

~auth-source-sops~ supports both simple and complex secret structures. You can use either ~.yaml~ or ~.json~ files.

#+begin_quote
*Important:* When using the default ~:incremental~ search method, the *top-level key* of your YAML/JSON file acts as a search index. To find a secret for a specific host, that host's name MUST be present in the top-level key (either as the key itself or part of a hierarchical key).
#+end_quote

You can use the key of the YAML object to define the host/user/port criteria, or define them explicitly within the value.

**** Simple String (Secret only)
The key will be parsed for host/user/port components.

#+begin_src yaml
# Simple host
github.com: my-secret-token

# User and host
user@github.com: my-secret-token

# Host and port
github.com:22: my-ssh-password
#+end_src

**** Structured Entry (Multiple fields)
Use a sequence of objects if you need to specify multiple users or specific fields for the same host.

#+begin_src yaml
api.github.com:
  - user: apikey
    secret: my-api-token
  - user: otheruser
    secret: other-token

# Mapping 'machine' to 'host' is supported for .netrc compatibility
database-host:
  - machine: db.example.com
    user: postgres
    port: 5432
    password: db-password
#+end_src

*** JSON Structure

The same logic applies to JSON files:

#+begin_src json
{
  "github.json": "json-secret",
  "real-host.com": [
    {
      "user": "admin",
      "secret": "admin-secret"
    }
  ]
}
#+end_src

** Configuration Options

All options can be configured via ~M-x customize-group auth-source-sops~.

- ~auth-source-sops-executable~ :: Path to the ~sops~ executable.
  - Default: ~"sops"~
- ~auth-source-sops-file~ :: The path to your encrypted credentials file.
  - Default: ~"~/.authinfo.sops.yaml"~
- ~auth-source-sops-age-key~ :: Optional path to a file containing your `age` private key. If set, this package will automatically set the ~SOPS_AGE_KEY~ environment variable during decryption.
  - Default: ~nil~
- ~auth-source-sops-search-method~ :: The strategy used to query the encrypted file.
  - ~:incremental~ (Default): Uses ~sops --extract~ to decrypt only the specific branch of the YAML/JSON structure that matches your host. This is faster for large files and avoids keeping the entire decrypted content in memory.
  - ~:full~: Decrypts the entire file once and performs the search locally in Emacs.

* Development

** Running Tests

This package includes a ~Makefile~ to simplify running tests.

#+begin_src sh
# Run all tests
make test

# Clean up compiled files and test artifacts
make clean
#+end_src

* License

GPLv3
