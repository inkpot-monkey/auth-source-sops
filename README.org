#+TITLE: auth-source-sops

Integrate [[https://getsops.io/][sops]] with Emacs ~auth-source~. This package allows you to store your secrets in encrypted YAML or JSON files and access them seamlessly from Emacs packages that use the standard ~auth-source~ API (like TRAMP, Gnus, etc.).

* Installation & Configuration

** Prerequisites

1. *sops binary*: The [[https://getsops.io/][sops]] executable must be installed and available in your ~exec-path~. Tested with **v3.11.0**.
2. *yaml.el*: Required for parsing decrypted YAML data.
3. *Emacs 25.1+*: Built-in ~json.el~ is used for JSON support.

** 1. Installation

Clone this repository and add it to your Emacs ~load-path~:

#+begin_src elisp
(add-to-list 'load-path "/path/to/auth-source-sops")
(require 'auth-source-sops)
#+end_src

** 2. Setup

Configure the location of your encrypted secrets file and (optionally) your age key file. Then call ~auth-source-sops-enable~ to register the backend.

#+begin_src elisp
;; Specify your encrypted secrets file (YAML or JSON)
(setq auth-source-sops-file "~/.authinfo.sops.yaml")

;; (Optional) Specify a file containing your age private key
;; This sets the SOPS_AGE_KEY environment variable for the sops process
(setq auth-source-sops-age-key "~/.config/sops/age/keys.txt")

;; Enable the integration
(auth-source-sops-enable)
#+end_src

~auth-source-sops-enable~ will verify that ~sops~ is installed and append ~sops~ to the global ~auth-sources~ list.

*** YAML Structure

~auth-source-sops~ supports both simple and complex secret structures. You can use either ~.yaml~ or ~.json~ files.

#+begin_quote
*Important:* When using the default ~:incremental~ search method, the *top-level key* of your YAML/JSON file acts as a search index. To find a secret for a specific host, that host's name MUST be present in the top-level key (either as the key itself or part of a hierarchical key).
#+end_quote

You can use the key of the YAML object to define the host/user/port criteria, or define them explicitly within the value.

**** Simple String (Secret only)
The key will be parsed for host/user/port components.

#+begin_src yaml
# Simple host
github.com: my-secret-token

# User and host
user@github.com: my-secret-token

# Host and port
github.com:22: my-ssh-password
#+end_src

**** Structured Entry (Multiple fields)
Use a sequence of objects if you need to specify multiple users or specific fields for the same host.

#+begin_src yaml
api.github.com:
  - user: apikey
    secret: my-api-token
  - user: otheruser
    secret: other-token

# Mapping 'machine' to 'host' is supported for .netrc compatibility
database-host:
  - machine: db.example.com
    user: postgres
    port: 5432
    password: db-password
#+end_src

*** JSON Structure

The same logic applies to JSON files:

#+begin_src json
{
  "github.json": "json-secret",
  "real-host.com": [
    {
      "user": "admin",
      "secret": "admin-secret"
    }
  ]
}
#+end_src

** Configuration Options

All options can be configured via ~M-x customize-group auth-source-sops~.

- ~auth-source-sops-executable~ :: Path to the ~sops~ executable.
  - Default: ~"sops"~
- ~auth-source-sops-file~ :: The path to your encrypted credentials file.
  - Default: ~"~/.authinfo.sops.yaml"~
- ~auth-source-sops-age-key~ :: Path to a file containing your `age` private key. Used when ~auth-source-sops-age-key-source~ is set to ~'file~.
  - Default: ~nil~
- ~auth-source-sops-age-key-source~ :: Where to obtain the Age private key. Options:
  - ~'environment~ (Default): Use existing ~SOPS_AGE_KEY~ environment variable.
  - ~'file~: Read from ~auth-source-sops-age-key~ file.
  - ~'ssh~: Derive from SSH key using ~ssh-to-age~.
- ~auth-source-sops-ssh-private-key~ :: Path to SSH private key when using ~'ssh~ source.
  - Default: ~"~/.ssh/id_ed25519"~
- ~auth-source-sops-ssh-to-age-executable~ :: Path to the ~ssh-to-age~ executable.
  - Default: ~"ssh-to-age"~
- ~auth-source-sops-search-method~ :: The strategy used to query the encrypted file.
  - ~:incremental~ (Default): Uses ~sops --extract~ to decrypt only the specific branch of the YAML/JSON structure that matches your host. This is faster for large files and avoids keeping the entire decrypted content in memory.
  - ~:full~: Decrypts the entire file once and performs the search locally in Emacs.

*** Using SSH Keys (ssh-to-age)

If you use SSH keys and don't want to manage separate age keys, you can configure ~auth-source-sops~ to automatically derive the age key from your SSH key:

#+begin_src elisp
(use-package auth-source-sops
  :config
  (setq auth-source-sops-file "~/.authinfo.sops.yaml")
  (setq auth-source-sops-age-key-source 'ssh)
  ;; Optional: customize SSH key path (default is ~/.ssh/id_ed25519)
  ;; (setq auth-source-sops-ssh-private-key "~/.ssh/my-custom-key")
  (auth-source-sops-enable))
#+end_src

This requires the [[https://github.com/Mic92/ssh-to-age][ssh-to-age]] tool to be installed. The age key is derived lazily on the first decrypt operation and cached for the duration of the Emacs session.

If you update your SSH key, call ~M-x auth-source-sops-clear-ssh-cache~ to re-derive the age key.

* Development

** Using Nix

This project uses Nix for reproducible development and CI. To enter a development environment with all dependencies (including ~sops~ and ~ssh-to-age~):

#+begin_src sh
nix develop
# Then run:
run-tests
#+end_src

To run the CI checks for all supported Emacs versions:

#+begin_src sh
nix flake check -L
#+end_src

** Using Makefile

Alternatively, you can use the provided ~Makefile~ if you have the dependencies installed on your system.

#+begin_src sh
# Compile the package
make compile

# Run all tests
make test

# Lint the code (requires package-lint)
make lint

# Clean up compiled files and test artifacts
make clean
#+end_src

* License

GPLv3
